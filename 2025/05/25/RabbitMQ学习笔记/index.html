<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>RabbitMQ学习笔记 | 李瑞康Blog</title><meta name="author" content="李瑞康"><meta name="copyright" content="李瑞康"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="RabbitMQ 学习笔记想要学习 RabbitMQ 首先要知道 MQ 是什么东西，MQ(消息队列) 可以在应用之间传递消息，主要用途为高并发时的削峰 ( 减少服务器压力 )，例如我们的 Controller 接收到请求不在调用 Service，而是将相关信息发送到消息队列中，那么监听这个队列的 Service 就可以接收到这条信息并处理，如果有多个 Service 监听了这个消息队列就可以达到削">
<meta property="og:type" content="article">
<meta property="og:title" content="RabbitMQ学习笔记">
<meta property="og:url" content="http://example.com/2025/05/25/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="李瑞康Blog">
<meta property="og:description" content="RabbitMQ 学习笔记想要学习 RabbitMQ 首先要知道 MQ 是什么东西，MQ(消息队列) 可以在应用之间传递消息，主要用途为高并发时的削峰 ( 减少服务器压力 )，例如我们的 Controller 接收到请求不在调用 Service，而是将相关信息发送到消息队列中，那么监听这个队列的 Service 就可以接收到这条信息并处理，如果有多个 Service 监听了这个消息队列就可以达到削">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/img/butterfly-icon.png">
<meta property="article:published_time" content="2025-05-25T02:16:31.000Z">
<meta property="article:modified_time" content="2025-05-25T02:19:38.415Z">
<meta property="article:author" content="李瑞康">
<meta property="article:tag" content="个人博客、个人网站">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/butterfly-icon.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "RabbitMQ学习笔记",
  "url": "http://example.com/2025/05/25/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/",
  "image": "http://example.com/img/butterfly-icon.png",
  "datePublished": "2025-05-25T02:16:31.000Z",
  "dateModified": "2025-05-25T02:19:38.415Z",
  "author": [
    {
      "@type": "Person",
      "name": "李瑞康",
      "url": "http://example.com/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2025/05/25/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'RabbitMQ学习笔记',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">李瑞康Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">RabbitMQ学习笔记</span></a></span><div id="menus"></div></nav><div id="post-info"><h1 class="post-title">RabbitMQ学习笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-05-25T02:16:31.000Z" title="Created 2025-05-25 10:16:31">2025-05-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-05-25T02:19:38.415Z" title="Updated 2025-05-25 10:19:38">2025-05-25</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%87%AA%E7%A0%94/">自研</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="RabbitMQ-学习笔记"><a href="#RabbitMQ-学习笔记" class="headerlink" title="RabbitMQ 学习笔记"></a>RabbitMQ 学习笔记</h1><p>想要学习 RabbitMQ 首先要知道 MQ 是什么东西，MQ(消息队列) 可以在应用之间传递消息，主要用途为高并发时的削峰 ( 减少服务器压力 )，例如我们的 Controller 接收到请求不在调用 Service，而是将相关信息发送到消息队列中，那么监听这个队列的 Service 就可以接收到这条信息并处理，如果有多个 Service 监听了这个消息队列就可以达到削峰的效果</p>
<p>市面上有很多的消息队列框架：RocketMQ、ActiveMQ、RabbitMQ、Kafka…. 这里学习的是 <code>RabbitMQ</code></p>
<p>本次是基于 ( Windows 7 ) 学习的 RabbitMQ 3.8.9，后面会简称为 RabbitMQ 为 rabbit</p>
<h2 id="RabbitMQ-的安装"><a href="#RabbitMQ-的安装" class="headerlink" title="RabbitMQ 的安装"></a>RabbitMQ 的安装</h2><p>rabbit 是基于 erlang 语言进行开发的，所以无论什么平台在安装 rabbit 之前必须先配置 erlang 的环境</p>
<h3 id="Windows-平台"><a href="#Windows-平台" class="headerlink" title="Windows 平台"></a>Windows 平台</h3><p>下载好必要的软件安装包：<code>otp_win64_23.1.exe</code> 和 <code>rabbitmq-server-3.8.9.exe</code></p>
<blockquote>
<p>配置 erlang</p>
</blockquote>
<p>安装过程十分简单，双击 opt 开头的文件下一步傻瓜式安装即可，安装时注意留意安装位置，然后在系统环境变量中添加 <code>ERLANG_HOME</code> 然后在 path 中配置 bin 目录，和 JDK 的环境基本是一样的</p>
<blockquote>
<p>安装 RabbitMQ</p>
</blockquote>
<p>同样双击 rabbit 开头的文件进行傻瓜式安装，安装完成后会在自动系统中创建一个 <code>RabbitMQ</code> 的服务，服务的开启和关闭就代表着 rabbit 的开启和关闭：</p>
<p><img src="/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/rabbit-01.jpg"></p>
<p>通过 windows 操作服务的命令 <code>net start ..</code> <code>net stop ..</code> 就可以控制 rabbit 的启动与关闭，这里我就把服务禁用了，测试环境下我选择通过控制台启动 rabbit</p>
<p>在 rabbit 服务关闭的情况下，通过双击 rabbit 安装目录下的 sbin 目录下的 <code>rabbitmq-server.bat</code> 文件，当看到控制台上的小兔子就代表 rabbit 启动成功了</p>
<p><img src="/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/rabbit-02.jpg"></p>
<p>通过 bat 文件启动 rabbit，cmd 窗口就代表 rabbit 服务，关闭窗口也就是关闭 rabbit，同 tomcat 一样</p>
<h3 id="CentOS-平台"><a href="#CentOS-平台" class="headerlink" title="CentOS 平台"></a>CentOS 平台</h3><p>研究的不透彻，等研究透彻再来记笔记，参考链接：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/fengyumeng/p/11133924.html">【保姆级】CentOS7安装RabbitMQ</a></p>
<blockquote>
<p>rabbit 常用操作命令</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">运行RabbitMQ</span></span><br><span class="line">rabbitmq-server</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">后台运行RabbitMQ</span></span><br><span class="line">rabbitmq-server -detached</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停止运行</span></span><br><span class="line">rabbitmqctl stop</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看RabbitMQ运行状态</span></span><br><span class="line">rabbitmqctl status</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">帮助</span></span><br><span class="line">rabbitmqctl help</span><br></pre></td></tr></table></figure>





<h2 id="RabbitMQ-基本配置使用"><a href="#RabbitMQ-基本配置使用" class="headerlink" title="RabbitMQ 基本配置使用"></a>RabbitMQ 基本配置使用</h2><p>我们查看 rabbit 安装目录下的 sbin 目录，可以看到目录下有一个 <code>rabbitmqctl.bat</code> 文件，我们想要通过命令操作 rabbit 必须要通过这个文件才可以，为了方便操作我们可以为 rabbit 配置一个环境变量：</p>
<ol>
<li>配置 <code>RABBIT_HOME</code> 系统变量到 rabbit 的安装目录下</li>
<li>在 <code>path</code> 下追加到 <code>sbin</code> 目录</li>
</ol>
<h3 id="命令简单介绍"><a href="#命令简单介绍" class="headerlink" title="命令简单介绍"></a>命令简单介绍</h3><p>我们可以通过调用 <code>help</code> 来查看一下命令的基本使用方法，就比如这一段：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">Administrator</span>&gt;<span class="title">rabbitmqctl</span> <span class="title">help</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 截取了一小块的内容，并非全部</span></span><br><span class="line"><span class="function">[1<span class="title">mUsers</span>[0<span class="title">m</span>: # <span class="title">Users</span>表示操作用户相关命令</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">   <span class="title">add_user</span>                      <span class="title">Creates</span> <span class="title">a</span> <span class="title">new</span> <span class="title">user</span> <span class="title">in</span> <span class="title">the</span> <span class="title">internal</span> <span class="title">database</span></span></span><br><span class="line"><span class="function">   <span class="title">authenticate_user</span>             <span class="title">Attempts</span> <span class="title">to</span> <span class="title">authenticate</span> <span class="title">a</span> <span class="title">user</span>. <span class="title">Exits</span> <span class="title">with</span> ......</span></span><br><span class="line"><span class="function">   <span class="title">change_password</span>               <span class="title">Changes</span> <span class="title">the</span> <span class="title">user</span> <span class="title">password</span></span></span><br><span class="line"><span class="function">   <span class="title">clear_password</span>                <span class="title">Clears</span> (<span class="title">resets</span>) <span class="title">password</span> <span class="title">and</span> <span class="title">disables</span> <span class="title">password</span> .....</span></span><br><span class="line"><span class="function">   <span class="title">delete_user</span>                   <span class="title">Removes</span> <span class="title">a</span> <span class="title">user</span> <span class="title">from</span> <span class="title">the</span> <span class="title">internal</span> <span class="title">database</span> ......</span></span><br><span class="line"><span class="function">   <span class="title">list_users</span>                    <span class="title">List</span> <span class="title">user</span> <span class="title">names</span> <span class="title">and</span> <span class="title">tags</span></span></span><br><span class="line"><span class="function">   <span class="title">set_user_tags</span>                 <span class="title">Sets</span> <span class="title">user</span> <span class="title">tags</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">[1<span class="title">mVirtual</span> <span class="title">hosts</span>[0<span class="title">m</span>: # <span class="title">Virtual</span>代表操作虚拟主机相关命令</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">   <span class="title">add_vhost</span>                     <span class="title">Creates</span> <span class="title">a</span> <span class="title">virtual</span> <span class="title">host</span></span></span><br><span class="line"><span class="function">   <span class="title">clear_vhost_limits</span>            <span class="title">Clears</span> <span class="title">virtual</span> <span class="title">host</span> <span class="title">limits</span></span></span><br><span class="line"><span class="function">   <span class="title">delete_vhost</span>                  <span class="title">Deletes</span> <span class="title">a</span> <span class="title">virtual</span> <span class="title">host</span></span></span><br><span class="line"><span class="function">   <span class="title">list_vhost_limits</span>             <span class="title">Displays</span> <span class="title">configured</span> <span class="title">virtual</span> <span class="title">host</span> <span class="title">limits</span></span></span><br><span class="line"><span class="function">   <span class="title">restart_vhost</span>                 <span class="title">Restarts</span> <span class="title">a</span> <span class="title">failed</span> <span class="title">vhost</span> <span class="title">data</span> <span class="title">stores</span> <span class="title">and</span> <span class="title">queues</span></span></span><br><span class="line"><span class="function">   <span class="title">set_vhost_limits</span>              <span class="title">Sets</span> <span class="title">virtual</span> <span class="title">host</span> <span class="title">limits</span></span></span><br><span class="line"><span class="function">   <span class="title">trace_off</span></span></span><br><span class="line"><span class="function">   <span class="title">trace_on</span></span></span><br><span class="line"><span class="function">   </span></span><br><span class="line"><span class="function">[1<span class="title">mAccess</span> <span class="title">Control</span>[0<span class="title">m</span>:</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">   <span class="title">clear_permissions</span>             <span class="title">Revokes</span> <span class="title">user</span> <span class="title">permissions</span> <span class="title">for</span> <span class="title">a</span> <span class="title">vhost</span></span></span><br><span class="line"><span class="function">   <span class="title">clear_topic_permissions</span>       <span class="title">Clears</span> <span class="title">user</span> <span class="title">topic</span> <span class="title">permissions</span> <span class="title">for</span> <span class="title">a</span> <span class="title">vhost</span> ......</span></span><br><span class="line"><span class="function">   <span class="title">list_permissions</span>              <span class="title">Lists</span> <span class="title">user</span> <span class="title">permissions</span> <span class="title">in</span> <span class="title">a</span> <span class="title">virtual</span> <span class="title">host</span></span></span><br><span class="line"><span class="function">   <span class="title">list_topic_permissions</span>        <span class="title">Lists</span> <span class="title">topic</span> <span class="title">permissions</span> <span class="title">in</span> <span class="title">a</span> <span class="title">virtual</span> <span class="title">host</span></span></span><br><span class="line"><span class="function">   <span class="title">list_user_permissions</span>         <span class="title">Lists</span> <span class="title">permissions</span> <span class="title">of</span> <span class="title">a</span> <span class="title">user</span> <span class="title">across</span> <span class="title">all</span> <span class="title">virtual</span> <span class="title">hosts</span></span></span><br><span class="line"><span class="function">   <span class="title">list_user_topic_permissions</span>   <span class="title">Lists</span> <span class="title">user</span> <span class="title">topic</span> <span class="title">permissions</span></span></span><br><span class="line"><span class="function">   <span class="title">list_vhosts</span>                   <span class="title">Lists</span> <span class="title">virtual</span> <span class="title">hosts</span></span></span><br><span class="line"><span class="function">   <span class="title">set_permissions</span>               <span class="title">Sets</span> <span class="title">user</span> <span class="title">permissions</span> <span class="title">for</span> <span class="title">a</span> <span class="title">vhost</span></span></span><br><span class="line"><span class="function">   <span class="title">set_topic_permissions</span>         <span class="title">Sets</span> <span class="title">user</span> <span class="title">topic</span> <span class="title">permissions</span> <span class="title">for</span> <span class="title">an</span> <span class="title">exchange</span></span></span><br></pre></td></tr></table></figure>

<p>可以看到大多数的命令，例如 <code>add_user 添加用户</code>，<code>list_user 查询所有用户</code>，<code>add_vhost 添加虚拟主机</code>，不用急着了解他们都是干什么的，先来照着敲一遍：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 查看所有用户(只有guest用户，默认密码也是guest，身份为administrator)</span><br><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">Administrator</span>&gt;<span class="title">rabbitmqctl</span> <span class="title">list_users</span></span></span><br><span class="line"><span class="function"><span class="title">Listing</span> <span class="title">users</span> ...</span></span><br><span class="line"><span class="function"><span class="title">user</span>    <span class="title">tags</span></span></span><br><span class="line"><span class="function"><span class="title">guest</span>   [<span class="title">administrator</span>]</span></span><br><span class="line"><span class="function"># 添加用户<span class="title">zhang</span>、密码为<span class="title">hanzhe</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Administrator</span>&gt;<span class="title">rabbitmqctl</span> <span class="title">add_user</span> <span class="title">zhang</span> <span class="title">hanzhe</span></span></span><br><span class="line"><span class="function"><span class="title">Adding</span> <span class="title">user</span> &quot;<span class="title">zhang</span>&quot; ...</span></span><br><span class="line"><span class="function"># 为用户<span class="title">zhang</span>分配<span class="title">administrator</span>权限</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Administrator</span>&gt;<span class="title">rabbitmqctl</span> <span class="title">set_user_tags</span> <span class="title">zhang</span> <span class="title">administrator</span></span></span><br><span class="line"><span class="function"><span class="title">Setting</span> <span class="title">tags</span> <span class="title">for</span> <span class="title">user</span> &quot;<span class="title">zhang</span>&quot; <span class="title">to</span> [<span class="title">administrator</span>] ...</span></span><br><span class="line"><span class="function"># 创建虚拟主机/<span class="title">push</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Administrator</span>&gt;<span class="title">rabbitmqctl</span> <span class="title">add_vhost</span> /<span class="title">push</span></span></span><br><span class="line"><span class="function"><span class="title">Adding</span> <span class="title">vhost</span> &quot;/<span class="title">push</span>&quot; ...</span></span><br><span class="line"><span class="function"># 用户绑定虚拟主机并设置权限</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Administrator</span>&gt;<span class="title">rabbitmqctl</span> <span class="title">set_permissions</span> -<span class="title">p</span> /<span class="title">push</span> <span class="title">zhang</span> &#x27;.&#x27; &#x27;.&#x27; &#x27;.&#x27;</span></span><br><span class="line"><span class="function"><span class="title">Setting</span> <span class="title">permissions</span> <span class="title">for</span> <span class="title">user</span> &quot;<span class="title">zhang</span>&quot; <span class="title">in</span> <span class="title">vhost</span> &quot;/<span class="title">push</span>&quot; ...</span></span><br></pre></td></tr></table></figure>

<p>这样我们就通过命令简单的创建了一个账号 <code>zhang</code>密码 <code>hanzhe</code> 的用户，并绑定了 <code>/push</code> 虚拟主机</p>
<h3 id="管理页面-管理插件"><a href="#管理页面-管理插件" class="headerlink" title="管理页面&amp;管理插件"></a>管理页面&amp;管理插件</h3><blockquote>
<p>插件命令简单了解</p>
</blockquote>
<p>命令不需要深入学习，了解到 help 随时查就可以了，大多数都是可以通过WEB页面进行操作的，接下来我们就来开启 rabbit 的 web 管理界面：</p>
<p>WEB 管理页面是 rabbit 中的一个插件 ( plugins )，需要调用命令来开启他，我们在来看下 sbin 目录，可以看到目录下有一个 <code>rabbitmq-plugins.bat</code> 文件，我们操作插件的命令都是靠他来完成的</p>
<p><img src="/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/rabbit-03.jpg"></p>
<p>同样调用一下他的 help 命令查看一下：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">1</span>mHelp[<span class="number">0</span>m:</span><br><span class="line"></span><br><span class="line">   autocomplete  Provides command name autocomplete variants</span><br><span class="line">   <span class="built_in">help</span>          Displays usage information <span class="keyword">for</span> a command</span><br><span class="line">   version       Displays CLI tools version</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>mMonitoring, observability and health checks[<span class="number">0</span>m:</span><br><span class="line"></span><br><span class="line">   directories   Displays plugin directory and enabled plugin file paths</span><br><span class="line">   is_enabled    Health check that exits with a non-zero code <span class="keyword">if</span> provided ......</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>mPlugin Management[<span class="number">0</span>m:</span><br><span class="line"></span><br><span class="line">   disable       Disables one or <span class="built_in">more</span> plugins</span><br><span class="line">   enable        Enables one or <span class="built_in">more</span> plugins</span><br><span class="line">   list          Lists plugins and their state</span><br><span class="line">   <span class="built_in">set</span>           Enables one or <span class="built_in">more</span> plugins, disables the rest</span><br></pre></td></tr></table></figure>

<p>可以看到 <code>list</code> 是查看所有插件及状态，<code>enable</code> 和 <code>disable</code> 来控制插件的启用与关闭</p>
<blockquote>
<p>开启管理页面插件</p>
</blockquote>
<p>这里我们启用页面管理插件 <code>rabbitmq_management</code>：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">Administrator</span>&gt;<span class="title">rabbitmq</span>-<span class="title">plugins</span> <span class="title">enable</span> <span class="title">rabbitmq_management</span></span></span><br><span class="line"><span class="function"><span class="title">Enabling</span> <span class="title">plugins</span> <span class="title">on</span> <span class="title">node</span> <span class="title">rabbit</span>@<span class="title">WIN</span>-<span class="title">DK6C2IC0EG9</span>:</span></span><br><span class="line"><span class="function"><span class="title">rabbitmq_management</span></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">following</span> <span class="title">plugins</span> <span class="title">have</span> <span class="title">been</span> <span class="title">configured</span>:</span></span><br><span class="line"><span class="function">    <span class="title">rabbitmq_management</span></span></span><br><span class="line"><span class="function">    <span class="title">rabbitmq_management_agent</span></span></span><br><span class="line"><span class="function">    <span class="title">rabbitmq_web_dispatch</span></span></span><br><span class="line"><span class="function"><span class="title">Applying</span> <span class="title">plugin</span> <span class="title">configuration</span> <span class="title">to</span> <span class="title">rabbit</span>@<span class="title">WIN</span>-<span class="title">DK6C2IC0EG9</span>...</span></span><br><span class="line"><span class="function"><span class="title">Plugin</span> <span class="title">configuration</span> <span class="title">unchanged</span>.</span></span><br></pre></td></tr></table></figure>

<p>这样我们就成功开启了他的 WEB 管理功能，访问 <code>http://localhost:15672/</code> 就可以访问到我们的管理页面了</p>
<p><img src="/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/rabbit-04.jpg"></p>
<p>我们之前使用命令的时知道了 rabbit 有默认提供的 guest 用户，也有我们自己新建的 zhang 用户，任意选择一个登录即可，需要注意的是 <strong>guest 只能本地登录</strong>，而我们自己创建的用户支持远程登录，如果是在远程 linux 中搭建的 rabbit 服务记得用命令行创建一个用户出来</p>
<p>登录成功后可以看到管理页面，分为几大模块：</p>
<p><img src="/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/rabbit-05.jpg"></p>
<p>通过用户模块可以看到之前创建的用户以及设置的权限和绑定的虚拟主机：</p>
<p><img src="/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/rabbit-06.jpg"></p>
<blockquote>
<p>其他插件介绍</p>
</blockquote>
<ul>
<li>rabbitmq_web_stomp rabbitmq_stomp rabbitmq_web_stomp_examples<ul>
<li>这三个插件是一起使用的，用于前端使用 websocket 连接 rabbit 服务</li>
</ul>
</li>
<li>rabbitmq_mqtt rabbitmq_web_mqtt<ul>
<li>这两个插件是一起使用的，同上面一样便于前端操作，不过使用的是 mqtt 协议而已</li>
</ul>
</li>
</ul>
<h2 id="RabbitMQ-初体验"><a href="#RabbitMQ-初体验" class="headerlink" title="RabbitMQ 初体验"></a>RabbitMQ 初体验</h2><blockquote>
<p>添加 Maven 依赖</p>
</blockquote>
<p>这里我们先创建简单 maven 工程，使用 rabbit 需要添加对应的 maven 依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.rabbitmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>amqp-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>创建生产者类</p>
</blockquote>
<p>按照之前的说法，将相关信息发送到消息队列中由其他服务进行处理，就相当于生产者消费者的关系，这里就简单创建两个类作为生产者和消费者，生产者用于向队列中发送消息，消费者监听队列取出消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生产者，用于将消息发送到消息队列中</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Provider1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 首先获取连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        <span class="comment">// 设置工厂的连接信息</span></span><br><span class="line">        factory.setUsername(<span class="string">&quot;zhang&quot;</span>);     <span class="comment">// 用户名</span></span><br><span class="line">        factory.setPassword(<span class="string">&quot;hanzhe&quot;</span>);    <span class="comment">// 密码</span></span><br><span class="line">        factory.setHost(<span class="string">&quot;192.168.1.147&quot;</span>); <span class="comment">// 服务地址</span></span><br><span class="line">        factory.setPort(<span class="number">5672</span>);            <span class="comment">// 端口号</span></span><br><span class="line">        factory.setVirtualHost(<span class="string">&quot;/push&quot;</span>);  <span class="comment">// 设置虚拟主机</span></span><br><span class="line">        <span class="comment">// 从工厂中创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">        <span class="comment">// 生产者向队列中写入消息是需要依靠通道的，这里通过链接对象创建通道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> conn.createChannel();</span><br><span class="line">        <span class="comment">// 我们的消息是要写入到队列中的，Rabbit中目前没有队列，所以我们需要声明出一个队列</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;queue-1&quot;</span>; <span class="comment">// 队列名称</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">durable</span> <span class="operator">=</span> <span class="literal">false</span>;      <span class="comment">// 是否持久化</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">exclusive</span> <span class="operator">=</span> <span class="literal">false</span>;    <span class="comment">// 是否排斥其他链接</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">autoDelete</span> <span class="operator">=</span> <span class="literal">true</span>;    <span class="comment">// 是否自动删除</span></span><br><span class="line">        <span class="comment">// 声明队列</span></span><br><span class="line">        channel.queueDeclare(queueName, durable, exclusive, autoDelete, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// 发送消息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;这是一条消息&quot;</span>;</span><br><span class="line">        channel.basicPublish(<span class="string">&quot;&quot;</span>, queueName, <span class="literal">null</span>, message.getBytes());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参数这里做一下详细的解释：</p>
<ul>
<li>声明队列 <code>queueDeclare</code> 时的相关配置<ul>
<li><code>queueName：</code> 第一个参数，队列的名称，在队列声明后可以在管理页面的 <code>Queues</code> 面板中看到该队列</li>
<li><code>durable：</code> 第二个参数，队列持久化，开启持久化后可以保持重启 rabbitm 后队列不会消失，这里需要注意一点，<em>队列持久化不代表消息就可以持久化，如果想要队列中的消息也持久化需要额外配置参数</em></li>
<li><code>exclusive：</code> 第三个参数，排斥设置，上述代码可以看出 <code>queue-1</code> 队列是由 <code>conn</code> 连接声明出来的，如果该值设置为 true 那么其他连接就都访问不了该通道</li>
<li><code>autoDelete：</code> 第四个参数，自动删除配置，当该队列的消息被消费完毕且没有任何消费者连接该队列时，队列会自动删除</li>
<li>第五个参数，是个 <code>map</code> 集合，用于对当前队列添加一个额外的配置 ( 例如生存时间 )</li>
</ul>
</li>
<li>发送消息 <code>basicPublish</code> 时的相关配置：<ul>
<li>第一个参数为交换机，这里用不到交换机，暂时设置为空字符串，注意<strong>不能为 null</strong>，否则会报错</li>
<li>第二个参数为路由参数，这里指定发送的目标队列名称即可</li>
<li>第三个参数为消息设置，例如上面提到的消息持久化就是在这里配置的</li>
<li>第四个参数为发送的具体消息，因为需要的是字节数组，所以这里用了 <code>getBytes</code> 方法</li>
</ul>
</li>
</ul>
<p>这样一来生产者就配置完成了，我们来运行一下看看效果</p>
<p><img src="/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/rabbit-07.jpg"></p>
<p>仔细看一下控制台，程序还没有结束运行，在 <code>Connections</code> 和 <code>Channels</code> 面板中也可以看到还有连接存在，所以在代码结束后需要关流</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Provider1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ......</span><br><span class="line">        channel.close();</span><br><span class="line">		conn.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>创建消费者类</p>
</blockquote>
<p>生产者已经完成了，向 queue-1 中插入了消息，接下来创建消费者来接收消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 一模一样的配置</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        factory.setUsername(<span class="string">&quot;zhang&quot;</span>);     <span class="comment">// 用户名</span></span><br><span class="line">        factory.setPassword(<span class="string">&quot;hanzhe&quot;</span>);    <span class="comment">// 密码</span></span><br><span class="line">        factory.setHost(<span class="string">&quot;192.168.1.147&quot;</span>); <span class="comment">// 服务地址</span></span><br><span class="line">        factory.setPort(<span class="number">5672</span>);            <span class="comment">// 端口号</span></span><br><span class="line">        factory.setVirtualHost(<span class="string">&quot;/push&quot;</span>);  <span class="comment">// 设置虚拟主机</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> conn.createChannel();</span><br><span class="line">        <span class="comment">// 因为队列已经存在了，所以这里就不进行声明了，直接订阅监听即可</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;queue-1&quot;</span>;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">autoAck</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// 消费者订阅队列进行监听</span></span><br><span class="line">        channel.basicConsume(queueName, autoAck, <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel)&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(</span></span><br><span class="line"><span class="params">                    String consumerTag,</span></span><br><span class="line"><span class="params">                    Envelope envelope,</span></span><br><span class="line"><span class="params">                    AMQP.BasicProperties properties,</span></span><br><span class="line"><span class="params">                    <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;接收到了消息： &quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 关流</span></span><br><span class="line">        channel.close();</span><br><span class="line">        conn.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参数这里做一下详细的解释：</p>
<ul>
<li>消费者的 <code>basicConsume</code> 相关配置<ul>
<li><code>queueName：</code> 监听的目标队列名称</li>
<li><code>autoAck：</code> 是否自动确认，这里使用 true 就可以了</li>
<li><code>DefaultConsumer：</code> 可以理解为回调方法，需要创建 <code>DefaultConsumer</code> 实例复写 <code>handleDelivery</code> 方法，该方法最后一个参数 ( 字节数组 ) 就是接收到的消息内容</li>
</ul>
</li>
</ul>
<p>运行结果为：</p>
<p><img src="/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/rabbit-08.jpg"></p>
<blockquote>
<p>抽取工具类 ( 后续操作都会用到该类 )</p>
</blockquote>
<p>通过上面的代码可以发现，无论生产者还是消费者，想要生产或消费消息都要获取到通道连接，所以我们可以抽出一个工具类，封装一些常用的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQ</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">URL</span> <span class="operator">=</span> <span class="string">&quot;192.168.1.108&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PORT</span> <span class="operator">=</span> <span class="number">5672</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">VIRTUAL</span> <span class="operator">=</span> <span class="string">&quot;/push&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">USERNAME</span> <span class="operator">=</span> <span class="string">&quot;zhang&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PASSWORD</span> <span class="operator">=</span> <span class="string">&quot;hanzhe&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取连接</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title function_">getConnection</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        factory.setHost(URL);</span><br><span class="line">        factory.setPort(PORT);</span><br><span class="line">        factory.setVirtualHost(VIRTUAL);</span><br><span class="line">        factory.setUsername(USERNAME);</span><br><span class="line">        factory.setPassword(PASSWORD);</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            conn = factory.newConnection();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> conn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过链接获取到通道</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Channel <span class="title function_">getChannel</span><span class="params">(Connection conn)</span>&#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            channel = conn.createChannel();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> channel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关流</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">(Channel channel)</span> &#123;</span><br><span class="line">        <span class="comment">// 这里可以通过通道获取到当前连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> channel.getConnection();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            channel.close();</span><br><span class="line">            conn.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;关流失败！&quot;</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="交换机的使用"><a href="#交换机的使用" class="headerlink" title="交换机的使用"></a>交换机的使用</h2><blockquote>
<p>消息队列流程简介</p>
</blockquote>
<p>按照刚刚的操作可以得到，我们正常操作消息队列应该是由生产者生产消息，发送到消息队列，然后由消费者来订阅消息队列，来接收生产者发出的消息从而执行业务逻辑，流程大概是这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">A(生产者) --&gt;B[消息队列] --&gt;C(消费者)</span><br><span class="line">       A --&gt;D[消息队列] --&gt;E(消费者)</span><br></pre></td></tr></table></figure>

<p>但是实际情况下生产者并不是直接将消息发送到消息队列的，而是中间经过一层 **交换机 ( exchange )**，生产者将消息发送到交换机，然后由交换机决定以什么方式发送，将消息分发到哪些队列</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">A(生产者) --&gt;B&#123;交换机&#125; --&gt;C[消息队列] --&gt;D(消费者)</span><br><span class="line">            B&#123;交换机&#125; --&gt;E[消息队列] --&gt;F(消费者)</span><br></pre></td></tr></table></figure>

<p>一个交换机可以连接多个消息队列，以什么方式发送消息取决于使用类型的交换机，rabbit 中有很多种类型的交换机，这里记录三种最常用的交换机类型：  <strong>扇形</strong>、<strong>直连</strong>、<strong>主题</strong></p>
<h3 id="扇形交换机"><a href="#扇形交换机" class="headerlink" title="扇形交换机"></a>扇形交换机</h3><blockquote>
<p>扇形交换机简单了解</p>
</blockquote>
<p>扇形交换机 ( <strong>fanout</strong> ) 的特点是 <em>可以将消息分发给每个队列</em>，所以他又被成为广播，流程图如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">A(生产者) --&gt;|发送消息|B&#123;扇形交换机&#125;</span><br><span class="line">            B --&gt;|接收到消息|C[队列1] --&gt;D(消费者1)</span><br><span class="line">			B --&gt;|接收到消息|E[队列2] --&gt;F(消费者2)</span><br><span class="line">            B --&gt;|接收到消息|G[队列3] --&gt;H(消费者3)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>创建消费者模型类</p>
</blockquote>
<p>我们在消费的时候需要创建 <code>DefaultConsumer</code> 类的实例，还要复写其中的方法，如果消费者比较多的话就会造成代码冗余，这里创建一个通用的消费者模型，用于后续的测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 继承了DefaultConsumer类的</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> <span class="keyword">extends</span> <span class="title class_">DefaultConsumer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String consumerName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第一个参数为消费者名称，第二个参数为通道</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Consumer</span><span class="params">(String consumerName, Channel channel)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(channel);</span><br><span class="line">        <span class="built_in">this</span>.consumerName = consumerName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag,</span></span><br><span class="line"><span class="params">            Envelope envelope,</span></span><br><span class="line"><span class="params">            AMQP.BasicProperties properties,</span></span><br><span class="line"><span class="params">            <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        System.out.println(<span class="built_in">this</span>.consumerName + <span class="string">&quot;： &quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>创建消费者类</p>
</blockquote>
<p>接下来我们来创建三个消费者来监听这个队列：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 消费者类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer2</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQ.getChannel(RabbitMQ.getConnection());</span><br><span class="line">        <span class="comment">// 这里声明三条队列，分别用三个消费者监听这个队列</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;queue-&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> queueName + i;</span><br><span class="line">            channel.queueDeclare(name, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">            channel.basicConsume(name, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">Consumer</span>(<span class="string">&quot;消费者&quot;</span> + i, channel));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 需要注意的是这里并没有关流，因为这里要实现长连接的监听效果</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>创建生产者类</p>
</blockquote>
<p>在之前初体验中的交换机使用的是空字符串，这次就要使用我们声明出来的交换机了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生产者，用于将消息发送到消息队列中</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Provider2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> RabbitMQ.getConnection();</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQ.getChannel(conn);</span><br><span class="line">        <span class="comment">// 声明交换机   第一个参数：交换机名称，  第二个参数：交换机类型</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;exchange-1-fanout&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> <span class="string">&quot;fanout&quot;</span>;</span><br><span class="line">        channel.exchangeDeclare(exchangeName, type);</span><br><span class="line">        <span class="comment">// 将三个队列绑定到交换机中，最后一个参数是路由参数，没用的东西不用管</span></span><br><span class="line">        channel.queueBind(<span class="string">&quot;queue-1&quot;</span>, exchangeName, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        channel.queueBind(<span class="string">&quot;queue-2&quot;</span>, exchangeName, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        channel.queueBind(<span class="string">&quot;queue-3&quot;</span>, exchangeName, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="comment">// 因为这里是将消息发送到交换机中，所以第二个参数就不用写了，把第一个交换机填上就行</span></span><br><span class="line">        channel.basicPublish(exchangeName, <span class="string">&quot;&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;123&quot;</span>.getBytes());</span><br><span class="line">        RabbitMQ.close(channel);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参数这里做一下详细的解释：</p>
<ul>
<li><code>queueBind</code> 绑定函数：第一个为队列名称，第二个为交换机名称，第三个为路由参数，他的作用是将队列添加到交换机的绑定当中，例如 <code>queueBind(&quot;queue-1&quot;, exchangeName, &quot;&quot;)</code> 这段代码表示是将 <code>queue-1</code> 队列绑定到 <code>exchangeName</code> 交换机中</li>
<li>路由参数在扇形交换机中不起作用，所以给个空字符串就够了，注意给 null 的话会报错</li>
</ul>
<blockquote>
<p>测试效果：</p>
</blockquote>
<p>这里生产者消费者已经都创建完成了，接下来就测试一下运行效果 ( 先运行消费者，声明队列并监听，然后在运行生产者 ) ，可以看到发送一条消息，三个消费者同时接收到了信息，证明了 <strong>扇形交换机的广播性质</strong></p>
<p><img src="/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/rabbit-09.jpg"></p>
<h3 id="直连交换机"><a href="#直连交换机" class="headerlink" title="直连交换机"></a>直连交换机</h3><p>直连交换机 ( <strong>direct</strong> ) 的特点是 <strong>接收到消息后会通过 <em>轮询</em> 的方式分发给消息队列</strong>，而想要实现这种效果，需要依靠路由参数 <code>routingKey</code> 才可以实现</p>
<p>在上面的 <code>Fanout</code> 交换机进行绑定操作的时候，最后一个参数就是路由参数，我们可以在队列绑定到交换机的时候可以约定一个参数，然后在生产者发送消息的时候在携带这个参数，这样依赖就可以保证只有符合条件的消费者才能接收到消息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">A(生产者) --&gt;|key:k2|B&#123;直连交换机&#125; </span><br><span class="line">			B --&gt;|key:k1|C[队列A] --&gt;D(消费者1)</span><br><span class="line">			B --&gt;|key:k2|E[队列B] --&gt;|符合条件接收到消息|F(消费者2)</span><br><span class="line">            B --&gt;|key:k3|G[队列C] --&gt;H(消费者3)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>消费者代码</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 消费者没有改动只不过队列在创建的时候取消了自动删除，所以这里就不用在创建一次了</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQ.getChannel(RabbitMQ.getConnection());</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;queue-&quot;</span> + i;</span><br><span class="line">            channel.basicConsume(queueName, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">Consumer</span>(<span class="string">&quot;消费者&quot;</span> + i, channel));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>生产者代码</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Provider3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQ.getChannel(RabbitMQ.getConnection());</span><br><span class="line">        <span class="comment">// 这里设置声明的交换机类型为直连</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;exchange-2-direct&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> <span class="string">&quot;direct&quot;</span>;</span><br><span class="line">        channel.exchangeDeclare(exchangeName, type);</span><br><span class="line">        <span class="comment">// 在队列绑定到交换机的时候，需要约定一个路由参数routingKey</span></span><br><span class="line">        channel.queueBind(<span class="string">&quot;queue-1&quot;</span>, exchangeName, <span class="string">&quot;k1&quot;</span>);</span><br><span class="line">        channel.queueBind(<span class="string">&quot;queue-2&quot;</span>, exchangeName, <span class="string">&quot;k2&quot;</span>);</span><br><span class="line">        channel.queueBind(<span class="string">&quot;queue-3&quot;</span>, exchangeName, <span class="string">&quot;k3&quot;</span>);</span><br><span class="line">        <span class="comment">// 在向交换机发送消息的时候携带路由参数，明确告诉交换机这条消息应该由哪些队列接收</span></span><br><span class="line">        channel.basicPublish(exchangeName, <span class="string">&quot;k1&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;哈哈&quot;</span>.getBytes());</span><br><span class="line">        channel.basicPublish(exchangeName, <span class="string">&quot;k2&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;嘿嘿&quot;</span>.getBytes());</span><br><span class="line">        channel.basicPublish(exchangeName, <span class="string">&quot;k3&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;嘻嘻&quot;</span>.getBytes());</span><br><span class="line">        RabbitMQ.close(channel);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>运行结果：</p>
</blockquote>
<p>因为约定了路由参数，所以只有符合条件的队列才能接收到对应的消息，运行结果为：</p>
<p><img src="/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/rabbit-10.jpg"></p>
<p>直连交换机需要通过 <code>routingKey</code> 进行约束，只有符合条件的队列才能接受到消息，如果有多个消息队列设置了同样的 <code>routingKey</code>，那么每个队列都能接收到消息，这就说明了一个问题，如果我们把所有 <code>routingKey</code> 都设置为一样的值，那么直连是可以当成广播使用的。</p>
<h3 id="主题交换机"><a href="#主题交换机" class="headerlink" title="主题交换机"></a>主题交换机</h3><p>主题交换机 ( <strong>topic</strong> )，是这三种交换机中最强大的交换机，他的使用方法和直连一样，通过 <code>RoutingKey</code> 来指定消息发送给指定的队列，但是主题交换机的强大之处就在于 <code>RoutingKey</code> 支持通配符</p>
<p><strong>通配符有两种表现形式：</strong></p>
<ul>
<li>routingkey 中小数点 <code>.</code> 代表着单词之间的分隔符</li>
<li><code>*</code>：星号通配符可以匹配单个单词</li>
<li><code>#</code>：井号通配符可以匹配任意数量 ( 0 ~ 无穷大 ) 的单词</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">A(生产者) --&gt;|发送消息|B&#123;主题交换机&#125; </span><br><span class="line">			B --&gt;|user.*|E[队列A] --&gt;F(消费者1)</span><br><span class="line">            B --&gt;|user.#|G[队列B] --&gt;H(消费者2)</span><br></pre></td></tr></table></figure>

<p>参数太多图画不下，这里就手动描述一下，当发送的消息 <code>RoutingKey</code> 为各种值时的反应：</p>
<ul>
<li><code>routingkey = user.insert</code>：两种消息队列都匹配，都可以接受的到</li>
<li><code>routingkey = user.insert.ok</code>：队列 B 接收的到，A 的星号只支持单个单词的通配符，所以接收不到</li>
<li><code>routingkey = user</code>：A 的星号只支持单个单词的通配符，所以接收不到，消息队列 B 接收的到 ( 0 ~ ∞ )</li>
</ul>
<blockquote>
<p>生产者代码：</p>
</blockquote>
<p>消费者监听改为前两个队列，其他代码不变，这里只修改生产者的绑定以及 <code>routingKey</code> 即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生产者</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Provider4</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQ.getChannel(RabbitMQ.getConnection());</span><br><span class="line">        <span class="comment">// 这里设置声明的交换机类型为直连</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;exchange-3-topic&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> <span class="string">&quot;topic&quot;</span>;</span><br><span class="line">        channel.exchangeDeclare(exchangeName, type);</span><br><span class="line">        <span class="comment">// 将三个队列绑定到交换机中，最后一个是路由参数，没用的东西不用管</span></span><br><span class="line">        channel.queueBind(<span class="string">&quot;queue-1&quot;</span>, exchangeName, <span class="string">&quot;user.*&quot;</span>);</span><br><span class="line">        channel.queueBind(<span class="string">&quot;queue-2&quot;</span>, exchangeName, <span class="string">&quot;user.#&quot;</span>);</span><br><span class="line">        <span class="comment">// 因为这里是将消息发送到交换机中，所以第二个参数就不用写了，把第一个交换机填上就行</span></span><br><span class="line">        channel.basicPublish(exchangeName, <span class="string">&quot;user.insert&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;哈哈&quot;</span>.getBytes());</span><br><span class="line">        channel.basicPublish(exchangeName, <span class="string">&quot;user.insert.ok&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;嘿嘿&quot;</span>.getBytes());</span><br><span class="line">        channel.basicPublish(exchangeName, <span class="string">&quot;user&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;嘻嘻&quot;</span>.getBytes());</span><br><span class="line">        RabbitMQ.close(channel);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>运行结果</p>
</blockquote>
<p>这里可以看到和我们之前推算的一样，消费者1只接收到了一条消息，消费者2接收到了所有消息</p>
<p><img src="/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/rabbit-11.jpg"></p>
<p>为什么说主题交换机最强大？因为在 <code>RoutingKey</code> 不使用通配符的情况下，他就是直连交换机，当使用通配符，但是只使用单个井号的话，那他就是扇形交换机，他可以充当三个交换机来使用！</p>
<h3 id="默认交换机的负载均衡"><a href="#默认交换机的负载均衡" class="headerlink" title="默认交换机的负载均衡"></a>默认交换机的负载均衡</h3><p>在初体验的时候我们尝试了不使用交换机进行交互，然而实际上在不指定交换机的情况下其实是通过了默认交换机进行操作的，<strong>rabbit 的默认交换机是直连交换机</strong>，这一点可以从管理页面的 <code>Exchanges</code> 面板中观察到</p>
<p><img src="/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/rabbit-12.jpg"></p>
<p>在默认交换机使用 <code>basicPublish</code> 函数的时使用队列名称作为路由参数，从而找到消息发送的目标</p>
<p>如果两个消费者监听同一个队列，会按照轮询的方式进行消费，队列会依次将消息分发给下面的消费者，消费者 A 的性能较高很快就可以完成，但消费者 B 会卡很久，这时就需要使用负载均衡方案了</p>
<blockquote>
<p>将默认交换机 ( 直连 ) 轮询改为负载均衡</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 消费者代码</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsumerExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQ.getChannel(RabbitMQ.getConnection());</span><br><span class="line">        <span class="comment">// 这里设置当前通道每次只处理一个消息，只有处理完当前消息才能拿到下一条，实现负载均衡</span></span><br><span class="line">        channel.basicQos(<span class="number">1</span>);</span><br><span class="line">        channel.basicConsume(<span class="string">&quot;queue-1&quot;</span>, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">Consumer</span>(<span class="string">&quot;消费者1&quot;</span>, channel));</span><br><span class="line">        channel.basicConsume(<span class="string">&quot;queue-1&quot;</span>, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">Consumer</span>(<span class="string">&quot;消费者2&quot;</span>, channel));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="其他操作"><a href="#其他操作" class="headerlink" title="其他操作"></a>其他操作</h2><h3 id="消息手动确认"><a href="#消息手动确认" class="headerlink" title="消息手动确认"></a>消息手动确认</h3><p>我们的消费者在接收到消息的时候会反馈给 rabbit 一个确认收到的信息，当 rabbit 确保你收到消息后才能分发下一条消息，但是这样有一个漏洞，如果我接收到消息并反馈，但是在业务逻辑执行一半的时候突然因为不可抗力的因素 ( 停电、断网等 …. ) 导致该消息并没有达到目标效果，但是 rabbit 却认为这条消息已经执行了，这就导致了一个问题：<strong>消息丢失</strong>，对于这个问题可以关闭自动确认，改为手动确认解决</p>
<p>首先向队列中添加一条消息 ( 代码就不粘了 ) ：</p>
<p><img src="/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/rabbit-13.jpg"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 消费者代码</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsumerExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQ.getChannel(RabbitMQ.getConnection());</span><br><span class="line">        <span class="comment">// 注意这里自动确认为false</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">autoAck</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        channel.basicConsume(<span class="string">&quot;queue-1&quot;</span>, autoAck, <span class="keyword">new</span> <span class="title class_">Consumer</span>(<span class="string">&quot;消费者&quot;</span>, channel));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后运行消费者，可以看到消息已经消费到了，但是我们在回到管理页面上看看：</p>
<p><img src="/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/rabbit-14.jpg"></p>
<p>队列消息总数没有变化，但是状态变成了 <code>Unacked</code> 代表着消息已读但未确认，具有该状态的消息在重启消费者后会重新消费，如果重新消费后还没有确认的话，那么再次重启还会重新消费，直到确认为止，消息才会被移除队列，这样我们就可以等待业务逻辑处理完成后在进行确认，就可以有效防止消息丢失的问题：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 消费者代码</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer5</span> <span class="keyword">extends</span> <span class="title class_">DefaultConsumer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Consumer5</span><span class="params">(Channel channel)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(channel);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQ.getChannel(RabbitMQ.getConnection());</span><br><span class="line">        channel.basicConsume(<span class="string">&quot;queue-1&quot;</span>, <span class="literal">false</span>, <span class="keyword">new</span> <span class="title class_">Consumer5</span>(channel));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(</span></span><br><span class="line"><span class="params">            String consumerTag,</span></span><br><span class="line"><span class="params">            Envelope envelope,</span></span><br><span class="line"><span class="params">            AMQP.BasicProperties properties,</span></span><br><span class="line"><span class="params">            <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 在这里处理业务逻辑</span></span><br><span class="line">        <span class="comment">// service.xxx</span></span><br><span class="line">        <span class="comment">// 手动确认该消息</span></span><br><span class="line">        <span class="built_in">super</span>.getChannel().basicAck(envelope.getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="获取队列信息"><a href="#获取队列信息" class="headerlink" title="获取队列信息"></a>获取队列信息</h3><p>我们在有些情况下需要获取到队列的一些相关信息来达到某些操作，这些在代码中可以这样实现：</p>
<blockquote>
<p>声明队列时的返回值</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQ.getChannel(RabbitMQ.getConnection());</span><br><span class="line">        <span class="comment">// 在声明队列的时候会返回一个DeclareOk的内部类对象，可以用它获取到相关信息</span></span><br><span class="line">        AMQP.Queue.<span class="type">DeclareOk</span> <span class="variable">declare</span> <span class="operator">=</span></span><br><span class="line">                channel.queueDeclare(<span class="string">&quot;z-queue&quot;</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">true</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// 获取队列名称</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> declare.getQueue();</span><br><span class="line">        <span class="comment">// 队列下消费者数量</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">consumerCount</span> <span class="operator">=</span> declare.getConsumerCount();</span><br><span class="line">        <span class="comment">// 队列下消息数量</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">messageCount</span> <span class="operator">=</span> declare.getMessageCount();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>获取指定队列的相关信息</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GetQueueInfo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQ.getChannel(RabbitMQ.getConnection());</span><br><span class="line">        <span class="comment">// 通过队列名称获取达到DeclareOk实例</span></span><br><span class="line">        AMQP.Queue.<span class="type">DeclareOk</span> <span class="variable">declare</span> <span class="operator">=</span> channel.queueDeclarePassive(<span class="string">&quot;z-queue&quot;</span>);</span><br><span class="line">        System.out.println(declare.getQueue());</span><br><span class="line">        System.out.println(declare.getConsumerCount());</span><br><span class="line">        System.out.println(declare.getMessageCount());</span><br><span class="line">        RabbitMQ.close(channel);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="设置超时时间"><a href="#设置超时时间" class="headerlink" title="设置超时时间"></a>设置超时时间</h3><blockquote>
<p>队列级别超时时间</p>
</blockquote>
<p>**1. **在声明队列的时候最后一个参数一直为 null，这里可以通过使用这个参数来设置 <strong>队列级别</strong> 的消息超时时间</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueueTimeout</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQ.getChannel(RabbitMQ.getConnection());</span><br><span class="line">        Map&lt;String, Object&gt; settings = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 设置消息超时时间ms，队列级别参数针对当前队列内的所有消息生效</span></span><br><span class="line">        settings.put(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">10</span> * <span class="number">1000</span>);</span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;queue-timeout-1&quot;</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">true</span>, settings);</span><br><span class="line">        channel.basicPublish(<span class="string">&quot;&quot;</span>, <span class="string">&quot;queue-timeout-1&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;123&quot;</span>.getBytes());</span><br><span class="line">        RabbitMQ.close(channel);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/rabbit-15.jpg"></p>
<p>**2. **除开设置队列级别的消息超时时间之外，还可以设置队列本身的超时时长：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueueTimeout2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQ.getChannel(RabbitMQ.getConnection());</span><br><span class="line">        Map&lt;String, Object&gt; settings = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 设置当前队列的超时时长ms，时间过后队列会自动删除</span></span><br><span class="line">        settings.put(<span class="string">&quot;x-expires&quot;</span>, <span class="number">10</span> * <span class="number">1000</span>);</span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;queue-timeout-1&quot;</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">true</span>, settings);</span><br><span class="line">        RabbitMQ.close(channel);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/rabbit-16.jpg"></p>
<blockquote>
<p>消息级别的超时时间</p>
</blockquote>
<p>除开上面两种方法之外，我们在发送消息的时候也可以针对消息设置超时时间</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueueTimeout3</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQ.getChannel(RabbitMQ.getConnection());</span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;queue-timeout-3&quot;</span>;</span><br><span class="line">        channel.queueDeclare(queueName, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">true</span>, <span class="literal">null</span>);</span><br><span class="line">        channel.basicPublish(<span class="string">&quot;&quot;</span>, queueName, getProp(<span class="number">10</span>), <span class="string">&quot;123&quot;</span>.getBytes());</span><br><span class="line">        channel.basicPublish(<span class="string">&quot;&quot;</span>, queueName, getProp(<span class="number">60</span>), <span class="string">&quot;456&quot;</span>.getBytes());</span><br><span class="line">        RabbitMQ.close(channel);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取配置实例</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> AMQP.BasicProperties <span class="title function_">getProp</span><span class="params">(<span class="type">int</span> second)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AMQP</span>.BasicProperties.Builder()</span><br><span class="line">            	<span class="comment">// 设置消息超时时间ms</span></span><br><span class="line">                .expiration(Long.toString((second * <span class="number">1000</span>)))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/rabbit-17.jpg"></p>
<p>这里已经可以看到结果了，我们可以点击队列名称进入队列详情页，通过 <code>Get Message(s)</code> 查看队列消息信息：</p>
<p><img src="/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.assets/rabbit-18.jpg"></p>
<h2 id="前端连接-RabbitMQ"><a href="#前端连接-RabbitMQ" class="headerlink" title="前端连接 RabbitMQ"></a>前端连接 RabbitMQ</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;ch&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>RabbitMQ<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 引入相关的JS文件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/stomp.js/2.3.3/stomp.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/sockjs-client/1.1.4/sockjs.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 初始化ws对象</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> url = <span class="string">&quot;192.168.1.108&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> ws = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">`ws://<span class="subst">$&#123;url&#125;</span>:15672/ws`</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 获得Stomp client对象</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> client = <span class="title class_">Stomp</span>.<span class="title function_">over</span>(ws);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 连接RabbitMQ</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> username = <span class="string">&quot;zhang&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> password = <span class="string">&quot;hanzhe&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> virtual = <span class="string">&quot;/push&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">    client.<span class="title function_">connect</span>(username, password, success, error, virtual);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 定义连接成功回调函数</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">success</span>(<span class="params">x</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> queue = <span class="string">&quot;queue-1&quot;</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// console.log(&quot;x&quot;, x);</span></span></span><br><span class="line"><span class="language-javascript">        client.<span class="title function_">subscribe</span>(<span class="string">`/queue/<span class="subst">$&#123;queue&#125;</span>`</span>, <span class="keyword">function</span> (<span class="params">res</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`接收到的消息为： <span class="subst">$&#123;res.body&#125;</span>`</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 定义错误时回调函数</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">error</span>(<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;error&quot;</span>, e);</span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>需要注意的是</strong>：协议为 <code>ws</code> 协议，需要先获取到 socket 对象，然后在交给 <code>Stomp</code> 返回客户端对象在进行操作</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="http://example.com">李瑞康</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="http://example.com/2025/05/25/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">http://example.com/2025/05/25/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/img/butterfly-icon.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width" href="/2025/05/25/Mybatis%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="Mybatis学习笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">Mybatis学习笔记</div></div><div class="info-2"><div class="info-item-1">MyBatis 笔记MyBatis 是基于 Java 语言的开源的持久层框架，利用实体类和数据表之间产生了关联，通过映射文件中的 sql 语句对数据库进行操作 使用 maven 创建工程需要导入 mybatis 的依赖： 12345&lt;dependency&gt;    &lt;groupId&gt;org.mybatis&lt;/groupId&gt;    &lt;artifactId&gt;mybatis&lt;/artifactId&gt;    &lt;version&gt;3.5.5&lt;/version&gt;&lt;/dependency&gt;    简单实例演示mybatis的持久层开发有两种方式，一种是原始的 dao 开发，比较繁琐，还有一种是基于接口的 JDK 动态代理开发，也是最普遍的一种开发模式 原始dao开发模式使用原始 dao 开发模式，首先第一步： 创建 mybatis 的核心配置文件，一般取名为...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/butterfly-icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">李瑞康</div><div class="author-info-description">一起努力</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">9</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">1</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#RabbitMQ-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0"><span class="toc-number">1.</span> <span class="toc-text">RabbitMQ 学习笔记</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RabbitMQ-%E7%9A%84%E5%AE%89%E8%A3%85"><span class="toc-number">1.1.</span> <span class="toc-text">RabbitMQ 的安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Windows-%E5%B9%B3%E5%8F%B0"><span class="toc-number">1.1.1.</span> <span class="toc-text">Windows 平台</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CentOS-%E5%B9%B3%E5%8F%B0"><span class="toc-number">1.1.2.</span> <span class="toc-text">CentOS 平台</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RabbitMQ-%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE%E4%BD%BF%E7%94%A8"><span class="toc-number">1.2.</span> <span class="toc-text">RabbitMQ 基本配置使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.2.1.</span> <span class="toc-text">命令简单介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E9%A1%B5%E9%9D%A2-%E7%AE%A1%E7%90%86%E6%8F%92%E4%BB%B6"><span class="toc-number">1.2.2.</span> <span class="toc-text">管理页面&amp;管理插件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RabbitMQ-%E5%88%9D%E4%BD%93%E9%AA%8C"><span class="toc-number">1.3.</span> <span class="toc-text">RabbitMQ 初体验</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%A4%E6%8D%A2%E6%9C%BA%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">1.4.</span> <span class="toc-text">交换机的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%87%E5%BD%A2%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">1.4.1.</span> <span class="toc-text">扇形交换机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B4%E8%BF%9E%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">1.4.2.</span> <span class="toc-text">直连交换机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E9%A2%98%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">1.4.3.</span> <span class="toc-text">主题交换机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E4%BA%A4%E6%8D%A2%E6%9C%BA%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.4.4.</span> <span class="toc-text">默认交换机的负载均衡</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C"><span class="toc-number">1.5.</span> <span class="toc-text">其他操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%89%8B%E5%8A%A8%E7%A1%AE%E8%AE%A4"><span class="toc-number">1.5.1.</span> <span class="toc-text">消息手动确认</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E9%98%9F%E5%88%97%E4%BF%A1%E6%81%AF"><span class="toc-number">1.5.2.</span> <span class="toc-text">获取队列信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E8%B6%85%E6%97%B6%E6%97%B6%E9%97%B4"><span class="toc-number">1.5.3.</span> <span class="toc-text">设置超时时间</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E8%BF%9E%E6%8E%A5-RabbitMQ"><span class="toc-number">1.6.</span> <span class="toc-text">前端连接 RabbitMQ</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/05/25/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="RabbitMQ学习笔记">RabbitMQ学习笔记</a><time datetime="2025-05-25T02:16:31.000Z" title="Created 2025-05-25 10:16:31">2025-05-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/05/25/Mybatis%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="Mybatis学习笔记">Mybatis学习笔记</a><time datetime="2025-05-25T02:16:02.000Z" title="Created 2025-05-25 10:16:02">2025-05-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/05/25/SpringMVC%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="SpringMVC学习笔记">SpringMVC学习笔记</a><time datetime="2025-05-25T02:15:29.000Z" title="Created 2025-05-25 10:15:29">2025-05-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/05/25/Redis%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="Redis学习笔记">Redis学习笔记</a><time datetime="2025-05-25T02:14:55.000Z" title="Created 2025-05-25 10:14:55">2025-05-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/05/25/Docker%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="Docker学习笔记">Docker学习笔记</a><time datetime="2025-05-25T02:14:27.000Z" title="Created 2025-05-25 10:14:27">2025-05-25</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By 李瑞康</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>